<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CasualMITEC - Staff Dashboard</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f9f9f9;}
header{padding:20px;background:#007BFF;color:white;text-align:center;}
.card{background:white;padding:15px;margin:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
button{padding:10px 20px;margin:5px;border:none;border-radius:5px;cursor:pointer;}
.clock-in{background:#28A745;color:white;}
.clock-out{background:#DC3545;color:white;}
</style>
</head>
<body>

<header>
<h1>CasualMITEC Dashboard</h1>
<p id="welcome-msg">Loading...</p>
<button onclick="logout()">Logout</button>
</header>

<section id="upcoming-shifts">
<h2>Upcoming Shifts</h2>
<div id="shift-list"></div>
</section>

<section id="announcements">
<h2>Latest Announcements</h2>
<div id="announcement-list"></div>
</section>

<script type="module">
import { auth, db } from './firebase-config.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { collection, query, where, orderBy, limit, getDocs, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

onAuthStateChanged(auth, async user=>{
  if(!user){ window.location.href='index.html'; }
  else{
    document.getElementById('welcome-msg').innerText=`Hi ${user.email}`;
    await loadShifts(user.uid);
    await loadAnnouncements();
  }
});

async function loadShifts(uid){
  const shiftQuery = query(collection(db,'shifts'), where('userId','==',uid), orderBy('date','asc'), limit(5));
  const snapshot = await getDocs(shiftQuery);
  const container = document.getElementById('shift-list');
  container.innerHTML='';
  snapshot.forEach(docSnap=>{
    const shift = docSnap.data();
    const shiftCard = document.createElement('div');
    shiftCard.className='card';
    shiftCard.innerHTML=`
      <strong>${shift.date} - ${shift.location}</strong><br>
      Shift: ${shift.startTime} - ${shift.endTime}<br>
      Status: ${shift.clockIn?'Clocked In':'Not Clocked In'}<br>
      <button class="clock-in" onclick="clockIn('${docSnap.id}')">Clock In</button>
      <button class="clock-out" onclick="clockOut('${docSnap.id}')">Clock Out</button>
    `;
    container.appendChild(shiftCard);
  });
}

async function clockIn(shiftId){
  await updateDoc(doc(db,'shifts',shiftId), { clockIn: serverTimestamp() });
  const uid = auth.currentUser.uid;
  loadShifts(uid);
}

async function clockOut(shiftId){
  await updateDoc(doc(db,'shifts',shiftId), { clockOut: serverTimestamp() });
  const uid = auth.currentUser.uid;
  loadShifts(uid);
}

async function loadAnnouncements(){
  const annQuery = query(collection(db,'announcements'), orderBy('date','desc'), limit(5));
  const snapshot = await getDocs(annQuery);
  const container = document.getElementById('announcement-list');
  container.innerHTML='';
  snapshot.forEach(docSnap=>{
    const ann = docSnap.data();
    const annCard = document.createElement('div');
    annCard.className='card';
    annCard.innerHTML=`<strong>${ann.date.toDate().toLocaleDateString()}</strong><br>${ann.message}`;
    container.appendChild(annCard);
  });
}

function logout(){ signOut(auth).then(()=>window.location.href='index.html'); }
</script>

</body>
</html>